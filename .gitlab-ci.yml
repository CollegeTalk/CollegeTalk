stages:
    - test
    - staging
    - deploy

test_frontend:
    stage: test
    image: node:alpine
    script:
        - cd Code/frontend
        - npm ci
        - npx jest --ci
    only:
        changes:
            - Code/frontend/**/*

test_api:
    stage: test
    script:
        - echo "Testing api"
    only:
        changes:
            - Code/api/**/*

staging_frontend_expo:
    stage: staging
    image: node:alpine
    variables:
        EXPO_TOKEN: $EXPO_TOKEN
    script:
        - cd Code/frontend
        - npm ci
        - apk add --no-cache bash
        - npx expo publish --non-interactive
    # only:
    #     changes:
    #         - Code/frontend/**/*

staging_api_container:
    stage: staging
    image: mcr.microsoft.com/azure-cli
    variables:
        SP_APP_ID: $SP_APP_ID
        SP_PASSWORD: $SP_PASSWORD
        SP_TENANT: $SP_TENANT
    script:
        - cd Code/api
        - az login --service-principal -u $SP_APP_ID -p $SP_PASSWORD --tenant $SP_TENANT
        - az acr build --registry collegetalk --image collegetalk-api-staging .
    only:
        refs:
            - merge_requests
        changes:
            - Code/api/**/*

deploy_api_container:
    stage: deploy
    image: mcr.microsoft.com/azure-cli
    variables:
        SP_APP_ID: $SP_APP_ID
        SP_PASSWORD: $SP_PASSWORD
        SP_TENANT: $SP_TENANT
    script:
        - cd Code/api
        - az login --service-principal -u $SP_APP_ID -p $SP_PASSWORD --tenant $SP_TENANT
        - az acr build --registry collegetalk --image collegetalk-api .
    only:
        - main
